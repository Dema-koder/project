{% extends 'core/base.html' %}

{% block title %}–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ - –ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ –º–µ–Ω—é{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h3>
                        <p class="mb-0">
                            {{ event.name }} ‚Ä¢ {{ event.event_date }} ‚Ä¢ {{ guests_count }} –≥–æ—Å—Ç–µ–π
                        </p>
                    </div>
                    <div>
                        <a href="/event/{{ event.id }}/menu/" class="btn btn-light btn-sm me-2">
                            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é
                        </a>
                        <button onclick="window.print()" class="btn btn-light btn-sm">
                            üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ–Ω—é -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üçΩÔ∏è –í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ–Ω—é</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for dish in popular_dishes %}
                    <div class="col-md-2 col-6 mb-2">
                        <div class="border rounded p-2 text-center">
                            <strong>{{ dish.name }}</strong>
                            <br>
                            <small class="text-muted">{{ dish.dish_type.name|default:"–†–∞–∑–Ω–æ–µ" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
        {% for category, items in categories.items %}
        <div class="card mb-4 shopping-category">
            <div class="card-header bg-light">
                <h4 class="mb-0">
                    {% if category == '–û–≤–æ—â–∏' %}ü•¨
                    {% elif category == '–ú—è—Å–æ' %}ü•©
                    {% elif category == '–ú–æ–ª–æ—á–Ω—ã–µ' %}ü•õ
                    {% elif category == '–ë–∞–∫–∞–ª–µ—è' %}üåæ
                    {% elif category == '–ù–∞–ø–∏—Ç–∫–∏' %}ü•§
                    {% else %}üì¶{% endif %}
                    {{ category }}
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th width="40%">–ü—Ä–æ–¥—É–∫—Ç</th>
                            <th width="20%">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                            <th width="20%">–î–ª—è –±–ª—é–¥</th>
                            <th width="20%" class="text-center">–ö—É–ø–ª–µ–Ω–æ</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in items %}
                        <tr class="shopping-item">
                            <td>
                                <strong>{{ item.ingredient.name }}</strong>
                                <br>
                                <small class="text-muted">–ï–¥. –∏–∑–º.: {{ item.ingredient.get_unit_display }}</small>
                            </td>
                            <td>
                                    <span class="badge bg-info fs-6">
                                        {{ item.quantity|floatformat:1 }}
                                    </span>
                                {% if item.ingredient.average_price %}
                                <br>
                                <small class="text-muted">
                                    ~{{ item.ingredient.average_price }} ‚ÇΩ/{{ item.ingredient.unit }}
                                </small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="small">
                                    {% for dish in item.dishes|slice:":3" %}
                                    <span class="badge bg-light text-dark mb-1">{{ dish }}</span><br>
                                    {% endfor %}
                                    {% if item.dishes|length > 3 %}
                                    <small class="text-muted">+ –µ—â–µ {{ item.dishes|length|add:"-3" }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check form-check-lg d-inline-block">
                                    <input class="form-check-input purchase-checkbox"
                                           type="checkbox"
                                           data-item-id="{{ item.ingredient.id }}"
                                           style="transform: scale(1.5);">
                                    <label class="form-check-label"></label>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">üí∞ –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h3>{{ total_cost|floatformat:2 }} ‚ÇΩ</h3>
                        <p class="text-muted">–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫—É–ø–æ–∫</p>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6>üí° –≠–∫–æ–Ω–æ–º–∏—è:</h6>
                            <ul class="mb-0">
                                <li>–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ –≥–æ—Å—Ç—è: <strong>{{ per_guest_cost|floatformat:2 }} ‚ÇΩ</strong></li>
                                <li>–ó–∞–∫—É–ø–∫–∞ –æ–ø—Ç–æ–º –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ 15-20%</li>
                                <li>–°–µ–∑–æ–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –¥–µ—à–µ–≤–ª–µ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <a href="/event/{{ event.id }}/menu/" class="btn btn-outline-primary w-100">
                            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <a href="/create/" class="btn btn-outline-success w-100">
                            üéâ –ù–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                        </a>
                    </div>
                    <div class="col-md-4 mb-2">
                        <button onclick="window.print()" class="btn btn-success w-100">
                            üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –∏–∑ localStorage
        const checkboxes = document.querySelectorAll('.purchase-checkbox');
        checkboxes.forEach(checkbox => {
            const itemId = checkbox.dataset.itemId;
            const savedState = localStorage.getItem(`purchase_${itemId}`);
            if (savedState === 'true') {
                checkbox.checked = true;
                checkbox.closest('tr').classList.add('table-success');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
            checkbox.addEventListener('change', function() {
                const itemId = this.dataset.itemId;
                localStorage.setItem(`purchase_${itemId}`, this.checked);

                if (this.checked) {
                    this.closest('tr').classList.add('table-success');
                } else {
                    this.closest('tr').classList.remove('table-success');
                }

                updateProgress();
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress() {
            const totalItems = checkboxes.length;
            const purchasedItems = document.querySelectorAll('.purchase-checkbox:checked').length;
            const progressPercent = (purchasedItems / totalItems) * 100;

            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            console.log(`–ö—É–ø–ª–µ–Ω–æ: ${purchasedItems}/${totalItems} (${progressPercent.toFixed(1)}%)`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        updateProgress();

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        const shoppingItems = document.querySelectorAll('.shopping-item');
        shoppingItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
            });
            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });
    });
</script>

<style>
    .shopping-category {
        border-left: 5px solid #007bff;
    }

    .table-success {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    @media print {
        .btn, .alert, .card-header .btn {
            display: none !important;
        }

        .card {
            border: 1px solid #000 !important;
            break-inside: avoid;
        }

        .shopping-category {
            border-left: 3px solid #000 !important;
        }
    }
</style>
{% endblock %}